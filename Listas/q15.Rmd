
--- output: 
  pdf_document:
    fig_crop: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
  )
options(
  OutDec = ",", 
  digits = 3, 
  knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```

```{r lib}
library(dplyr)
library(ggplot2)
library(forcats)
library(magrittr)
library(broom)
source("plot_functions.R")
```

```{r import, echo=FALSE}
df <- read.table(
  "Braga1998.txt", 
  header = FALSE, 
  col.names = c("etiologia", "carga", "VO2"))
```

# Questão 3

## Introdução

O conjunto de dados é referente a um estudo sobre teste de esforço cardiopulmonar em pacientes com insufiência cardíaca realizado no InCor da Faculdade de Medicina da USP.
 O objetivo é comparar os grupos formados pelas diferentes etiologias cardíacas analisando variação do consumo de oxigênio no ponto de compensação respiratório (PCR), em (ml/(kg.min)) em função da carga utilizada na esteira ergométrica para para pacientes com diferentes etiologias cardíacas.


## Análise descritiva

Como os dados são separados pela variável categórica referente as etiologias cardíacas, pode-se levá-las em consideração na análise.
Logo, na Figura 1 estão os boxplots do consumo de oxigênio (VO2) para cada etiologia. Ela indica que o VO2 da etiologia "C" é em média maior que o VO2 das demais etiologias. 
Na Figura 2, temos os gráficos de dispersão do consumo de oxigênio (VO2) para cada etiologia cardíaca. Pode-se perceber que a relação entre a carga submetida e o consumo de oxigênio pode ser representada por uma reta, onde a relação é positiva, e quanto maior a carga, maior será o consumo de oxigênio.

Apesar de o VO2 ter distribuição diferente para as etiologias, essa diferença é mais atenuada e não é possível concluir, apenas da através da análise descritiva, que o VO2 médio é diferente para as etiologias "CH", "ID" e "IS".

```{r explore}
ggplot(df, aes(etiologia, VO2)) + 
  geom_boxplot() + 
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic()
```

```{r}
ggplot(df, aes(carga, VO2)) + 
  geom_point(alpha= 0.8) + 
    facet_wrap(~ etiologia) +
      theme_bw()
```

## Análise inferencial

### Modelos

<!-- O modelo que explica a variação do consumo de oxigênio (VO2) da carga de compensação respiratório (carga) desconsiderando as etiologias é $Y_{i j} = \beta_{0} + \beta_{1} (x_{i j} - \bar{x}) + \epsilon_{i j}, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$, que será chamado de Modelo 1, onde  -->

<!-- - $Y_{i j}$ e $x_{i j} - \bar{x}$ é o VO2 e a carga (centrada na média) do i-ésimo indivíduo da j-ésima etiologia, respectivamente -->
<!-- - $\beta_{0}$ é o VO2 esperado quando a carga assume seu valor médio -->
<!-- - $\beta_{1}$ é a variação esperada em VO2 quando a carga varia em uma unidade -->

Sejam $j = 1, 2, 3, 4$ índices para as etiologias "C", "CH", "ID e "IS", respectivamente. 

O modelo que explica a variação do consumo de oxigênio (VO2) da carga de compensação respiratório (carga) considerando as etiologias (com interação entre carga e etiologia) é $Y_{i j} = \beta_{0 j} + \beta_{1 j} (x_{i j} - \bar{x}) + \epsilon_{i j}, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$, que será chamado de Modelo 2, onde

- $Y_{i j}$ e $x_{i j}$ é o VO2 e a carga do i-ésimo indivíduo da j-ésima etiologia, respectivamente.
- $\beta_{0 j}$ é o VO2 esperado quando a carga assume seu valor médio e a etiologia assume o valor associado ao índice $j$
- $\beta_{1 j}$ é a variação esperada de VO2 quando a carga varia em uma unidade e a etiologia assume o valor associado ao índice $j$

Uma hipótese de interesse é testar se os efeitos de VO2 são iguais para todas as etiologias: $H_0: \beta_{1 1} = ... = \beta_{1 4} = 0$ \textit{versus} $H_1: \text{para algum algum} \ j \ \text{tal que} \ \beta_{1 j} \neq 0$, ou seja, se é possível reduzir o modelo desconsiderando a interação entre carga e etiologia.

Nesse caso, o modelo que explica a variação do consumo de oxigênio (VO2) da carga de compensação respiratório (carga) considerando as etiologias de maneita aditiva (sem interações) é o Modelo 2: $Y_{i j} = \beta_{0 j} + \beta_{1} (x_{i j} - \bar{x}) + \epsilon_{i j}, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$, onde

- $Y_{i j}$ e $x_{i j}$ é o VO2 e a carga do i-ésimo indivíduo da j-ésima etiologia, respectivamente.
- $\beta_{0 j}$ é o VO2 esperado quando a carga assume seu valor médio e a etiologia assume o valor associado ao índice $j$
- $\beta_{1}$ é a variação esperada de VO2 quando a carga varia em uma unidade 


### Resultados

A Tabela X apresenta os resultados do ajuste do Modelo 1 com a parametrização de casela de referência (etiologia "C"): termos do modelo (term), estimativas pontuais (estimate), erro padrão (std.error), p-valores (p.value) intervalos de confiança (conf.low e conf.high).

```{r}
modelo_etiologia <- df %$%
  lm(VO2 ~ etiologia * I(carga - mean(carga)))
tidy(modelo_etiologia, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()
```

Todos os p-valores associados aos parâmetros de interação não foram significativos, ou seja, foram maiores que $0,1$ com exceção de $\beta_{1 2}$, cujo p-valor, $0,06$, foi marginal.

Isso indica que é razoável considerar o Modelo 2 para a análise, i.e., sem interações. A Tabela X apresenta os resultados desse modelo.

```{r}
modelo_etiologia <- df %$%
  lm(VO2 ~ etiologia + I(carga - mean(carga)))
tidy(modelo_etiologia, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()
```

A Figura X apresenta o gráfio do VO2 em função da carga, a reta ajustada e o intervalo de confiança para as predições (área em torno da reta). Logo percebe-se que o modelo não capta todas as observações. Logo é necessário realizar um ajuste.

A Figura X apresenta os gráficos de análise de resíduos: o primeiro gráfico não sugere qualquer anormalidade, como dependência; o segundo indica heterocedasticidade; o terceiro indica que pode ser razoável a normalidade, no entanto, o quarto gráfico demonstra não ser possível tal suposição, visto que o QQ-plot tem concavidade para cima, indicando assimetria positiva dos dados e tem grande parte da cauda positiva fora da banda de confiança.

```{r}
plot_prediction(modelo_etiologia, df$VO2, "VO2")  
plot_residuals(modelo_etiologia)
```

### Modelo reduzido ao máximo

```{r}
df <- mutate(df, etiologia = forcats::fct_collapse(etiologia, Other = c("C", "CH"), IS = "IS", ID = "ID"))
modelo_reduzido <- df %$%
  lm(VO2 ~ etiologia + I(carga - mean(carga)))
tidy(modelo_reduzido, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()
plot_prediction(modelo_reduzido, df$VO2, "VO2")  
plot_residuals(modelo_reduzido)
```


## Conclusão


