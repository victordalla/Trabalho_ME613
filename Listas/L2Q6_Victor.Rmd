---
title: "Lista 2 - Questão 5-7"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE,
  warning = FALSE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
  )
options(
  OutDec = ",", 
  knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```

```{r lib}
library(ggplot2)
library(ggrepel)
library(magrittr)
library(broom)
library(dplyr)
source("plot_functions.R")
```

```{r 6-import, echo=FALSE}
df <- read.table(
  "../Dados/imoveis.txt", 
  header = FALSE, 
  col.names = c("Imposto", "Area_Ter", "Area_Cons", "Idade", "Preco"))
```

# Questão 6

## Introdução

Os dados são isso e aquilo. O objetivo é sei lá, que será estudado através do modelo X.

## Análise descritiva

```{r 6-explore}
GGally::ggcorr(df)
```

A Figura X apresenda um gráfico de matriz de correlação - cada célula (quadrado) deve ser lido como a correlção entre a covariável de sua linha e coluna codificada pelas cores apresentadas na legenda. Ele sugere que

i) As variáveis Imposto, Area_Ter e Area_Cons têm forte correlação (linear) com o preço (Preco), o que indica que são boas candidatas a serem usadas num modelo de regressão linear. No entanto, a variável Idade parece não estar correlacionada com o preço.

ii) Existe uma forte correlação (linear) entre as variáveis (explicatórias) Imposto, Area_Ter e Area_Cons. Essa conclusão faz sentido, visto que a área construída não pode ser maior que a área do terreno e que o imposto normalmente tem regras que levam em conta as duas áreas. Isso pode significar perdas na qualidade do modelo (conclusões feitas pelas estimativas dos coeficientes e poder prediditivo). Assim, deve-se procurar uma combinação (linear, por exemplo) dessas variáveis para ser usada no modelo no lugar delas.

## Análise inferencial

Sejam $Y_i$ o preço do i-ésimo imóvel e $x_1, ..., x_4$ os valores do imposto, área do terreno, área construída e idade do imóvel, respectivamente. Então $x_1^{*}, ..., x_4^{*}$ são os rescpectivos valores padronizados, ou seja, $x_i^{*} = \frac{x_i - \bar{x}}{DP(x)}, i = 1, ..., 4$, onde DP denota o desvio padrão amostral da covariável.

O modelo considerado para este estudo inicialmente será o Modelo 1: $Y_i = \beta_0 + \beta_1 x_1^{*} + ... + \beta_4 x_4^{*}  + \epsilon_{i}, \epsilon_{i} \stackrel{iid}\sim N(0, \sigma^2)$, onde $\beta_i, i = 1, ..., 4$ são os coeficientes associados ao imposto, área do terreno, área construída e idade do imóvel padronizados, respectivamente e $\beta_0$ é o preço médio quando todas as covariáveis assumem seu valor médio, visto que não faz sentido que elas assumam valor zero.

### Resultados

A Tabela X apresenta os resultados do ajuste do Modelo 1: termos do modelo (term), estimativas pontuais (estimate), erro padrão (std.error), p-valores (p.value) intervalos de confiança (conf.low e conf.high).

```{r 6-modelo}
modelo_simples <- mutate_at(df, vars(-Preco), function(x) (x - mean(x)) / sd(x)) %$% 
  lm(Preco ~ Imposto + Area_Ter + Area_Cons + Idade)

tidy(modelo_simples, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()
```

Como esperado, a idade do imóvel não impacta no preço do imóvel. No entanto, contrário ao esperado, a área do terreno não impacta o preço nesse  modelo; isso pode ser devido à alta correlação dessa variável com as outras.

A Tabela X apresenta os resultados do ajuste do Modelo 2: $Y_i = \beta_0 + \beta_1 x_1^{*} + \beta_3 x_3^{*}  + \epsilon_{i}, \epsilon_{i} \stackrel{iid}\sim N(0, \sigma^2)$, cujos parâmetros têm a interpretação ususal (as mesmas da do Modelo 1) e considera apenas as covariáveis impostos e área construída (padronizadas.

```{r 6-modelo_reduzido}
modelo_reduzido <- mutate_at(df, vars(-Preco), function(x) (x - mean(x)) / sd(x)) %$% 
  lm(Preco ~ Imposto + Area_Cons)

tidy(modelo_reduzido, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()
```

## c)

```{r 6-plot}
plot_prediction(modelo_reduzido, df$Preco, "Preço")
```

# 7

```{r 7-import, echo=FALSE}
df <- read.table(
  header = FALSE, 
  col.names = c("Etiologia", "Carga", "VO2"), 
  text = "
      CH        64.0       13.40
    CH        71.0       12.70
    ID        27.0       8.80
    ID        82.0       12.20
    IS        38.0       10.70
    CH        47.0       12.90
    ID         3.0       7.30
    IS        41.0       10.20
    ID        48.0       9.70
    CH        97.0       15.30
    ID        55.0       10.50
    CH        49.0       13.20
    CH        95.0       17.10
    CH        23.0       9.70
    IS        80.0       10.80
    CH        66.0       11.30
    CH        64.0       15.80
    CH        85.0       22.80
    IS        45.0       10.70
    ID        75.0       14.30
    ID        95.0       12.90
    ID        48.0       10.60
    CH        55.0       12.80
    CH        41.0       10.50
    CH        86.0       14.30
    CH        66.0       9.50
    ID        64.0       11.50
    ID        125.0      18.40
    ID        82.0       15.60
    ID        13.0       9.60
    ID        97.0       15.80
    IS        68.0       26.00
    ID        47.0       8.60
    CH        75.0       12.20
    ID        105.0      18.20
    CH        127.0      23.60
    ID        97.0       13.00
    IS        65.0       6.90
    ID        64.0       12.10
    CH        157.0      29.80
    CH        71.0       15.10
    ID        60.0       12.80
    CH        97.0       20.70
    IS        52.0       9.30
    IS        85.0       11.30
    IS        85.0       15.80
    IS        14.0       8.60
    IS        85.0       14.60
    ID        95.0       13.40
    CH        60.0       10.99
    ID        73.0       13.81
    ID        30.0       9.81
    CH        55.0       10.40
    ID        67.0       10.30
    ID        60.0       8.24
    CH        70.0       16.61
    ID        90.0       15.35
    ID        47.0       14.50
    ID        37.5       12.96
    IS        115.0      14.90
    IS        40.5       9.50
    CH        82.0       15.10
    IS        47.0       11.40
    IS        75.0       17.20
    IS        47.0       11.30
    IS        75.0       12.80
    IS        105.0      16.00
    IS        95.0       17.30
    IS        54.0       11.20
    IS        43.0       12.70
    IS        71.0       14.00
    ID        78.0       13.10
    ID        56.0       10.90
    IS        25.0       10.00
    CH        125.0      18.70
    CH        42.0       11.10
    ID        103.0      14.80
    IS        85.0       14.10
     C        84.0       14.00
     C        96.0       11.60
     C        85.0       14.50
     C        105.0      22.60
     C        88.0       14.40
     C        88.0       19.40
     C        118.0      21.10
     C        86.0       21.50
     C        92.0       21.70
     C        82.0       13.20
     C        65.0       13.60
     C        71.0       12.66
     C        94.0       16.30
     C        114.0      18.50
     C        86.0       14.90
     C        162.0      20.80
     C        169.0      26.30
     C        150.0      20.10
     C        188.0      24.70
     C        73.0       18.50
     C        74.0       15.60
     C        114.0      15.20
     C        129.0      18.70
     C        187.0      26.30
     C        112.0      15.00
     C        75.0       13.90
     C        115.0      18.30
     C        150.0      22.60
     C        64.0       12.80
     C        94.0       16.00
     C        71.0       12.50
     C        60.0       11.80
     C        67.0       12.70
     C        56.0       11.90
     C        131.0      25.20
     C        171.0      24.50
     C        35.0       11.50
     C        75.0       15.50
     C        124.0      25.30
     C        110.0      21.50
  ")
```

```{r}
ggplot(df, aes(Carga, VO2)) + 
  geom_point(col = "cadetblue") + 
  facet_wrap(~Etiologia) + 
  theme_bw()
```

Pelo gráfico acima, é razoável ajustar o modelo 

\[
Y_i = \alpha + \beta x + \gamma_1 d_1 + \gamma_2 d_2 + \gamma_3 d_3 + \delta_1 xd_1 \delta_2 xd_2 \delta_3 xd_3
\]

Onde "C" é a casela de referência, $d_1, d_2, d_3$ são as indicadoras de "CH", "ID" e "IS", respectivamente.

```{r}
# C é a casela de referência
fit <- mutate(df, Carga = Carga - mean(Carga)) %$% 
  lm(VO2 ~ Carga + Etiologia + Carga * Etiologia)
tidy(fit, conf.int = TRUE) %>% 
  select(-statistic, -std.error) %>% 
  knitr::kable(resultados)
```

```{r}
df %<>% cbind(predict.lm(fit, interval = "prediction"))


filter(resultados, term %in% c("Carga", "Carga:EtiologiaCH", "Carga:EtiologiaID", "Carga:EtiologiaIS")) %>% 
  ggplot(aes(term, estimate)) + 
    geom_pointrange(aes(ymin = conf.low, ymax = conf.high), col = "chocolate") + 
    geom_point(col = "darkviolet", size = 2) + 
    theme_bw()

ggplot(df, aes(Carga, VO2)) + 
  geom_point(col = "cadetblue") + 
  geom_line(aes(y = fit), col = "chocolate") + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "coral", alpha = 0.3) + 
  facet_wrap(~Etiologia) + 
  theme_bw()
```


