---
title: "Lista 1 - Questão 15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
  )
options(
  OutDec = ",", 
  knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```

```{r lib}
library(dplyr)
library(ggplot2)
library(forcats)
library(magrittr)
library(broom)
source("plot_functions.R")
```

```{r import, echo=FALSE}
df <- read.table(
  "../Dados/Braga1998PCR.txt", 
  header = FALSE, 
  col.names = c("etiologia", "carga", "VO2"))
```

# Questão 3

## Introdução

Os dados são isso e aquilo. O objetivo é sei lá, que será estudado através do modelo X.

## Análise descritiva

Na figura abaixo estão os boxplots do consumo de oxigênio (VO2) para cada etiologia. Ela indica que o VO2 da etiologia "C" é em média maior que o VO2 das demais etiologias. 

Apesar de o VO2 ter distribuição diferente para as outras etiologias, essa diferença é mais atenuada e não é possível concluir, apenas da através da análise descritiva, que o VO2 médio é diferente para as etiologias "CH", "ID" e "IS".

```{r explore}
ggplot(df, aes(etiologia, VO2)) + 
  geom_boxplot() + 
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic()
```

## Análise inferencial

O modelo que explica a variação do consumo de oxigênio (VO2) da carga de compensação respiratório (carga) desconsiderando as etiologias é $Y_{i j} = \beta_{0} + \beta_{1} (x_{i j} - \bar{x}) + \epsilon_{i j}, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$, que será chamado de Modelo 1, onde 

- $Y_{i j}$ e $x_{i j} - \bar{x}$ é o VO2 e a carga (centrada na média) do i-ésimo indivíduo da j-ésima etiologia, respectivamente
- $\beta_{0}$ é o VO2 esperado quando a carga assume seu valor médio
- $\beta_{1}$ é a variação esperada em VO2 quando a carga varia em uma unidade

Agora seja $j = 1, 2, 3, 4$ índices para as etiologias "C", "CH", "ID e "IS", respectivamente. 
<!-- $d_j = 1$ quando a etiologia assume o valor associado ao índice $j$ e $d_j = 0$ caso contrário. -->

O modelo que explica a variação do consumo de oxigênio (VO2) da carga de compensação respiratório (carga) considerando as etiologias é $Y_{i j} = \beta_{0 j} + \beta_{1 j} (x_{i j} - \bar{x}) + \epsilon_{i j}, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$, que será chamado de Modelo 2, onde

- $Y_{i j}$ e $x_{i j}$ é o VO2 e a carga do i-ésimo indivíduo da j-ésima etiologia, respectivamente.
- $\beta_{0 j}$ é o VO2 esperado quando a carga assume seu valor médio e a etiologia assume o valor associado ao índice $j$
- $\beta_{1 j}$ é a variação esperada de VO2 quando a carga varia em uma unidade e a etiologia assume o valor associado ao índice $j$

Para o Modelo 1, uma hipótese de interesse é $H_0: \beta_{1} = 0$ \textit{versus} $H_1: \beta_{1} \neq 0$. Em termos do problema, isso significa testar se a carga tem efeito no VO2 de um indivíduo. Para o Modelo 2, uma hipótese de interesse é $H_0: \beta_{1 1} = ... = \beta_{1 4} = 0$ \textit{versus} $H_1: \text{para algum algum} \ j \ \text{tal que} \ \beta_{1 j} \neq 0$. Em termos do problema, isso significa testar se os efeitos de VO2 são iguais para todas as etiologias.

### Resultados

A Tabela X apresenta os resultados do ajuste do modelo do item b): termos do modelo (term), estimativas pontuais (estimate), erro padrão (std.error), p-valores (p.value) intervalos de confiança (conf.low e conf.high).

```{r}
modelo_etiologia <- df %$%
  lm(VO2 ~ etiologia * I(carga - mean(carga)))

tidy(modelo_etiologia, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()
```

Todos os p-valores associados aos parâmetros de interação não foram significativos, ou seja, foram maiores que $0,1$ com exceção de $\beta_{1 2}$, cujo p-valor, $0,06$, foi marginal.

Isso indica que é razoável desconsiderar um modelo aditivo, i.e., sem interações: $Y_{i j} = \beta_{0 j} + \beta_{1} (x_{i j} - \bar{x}) + \epsilon_{i j}, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$, onde

- $Y_{i j}$ e $x_{i j}$ é o VO2 e a carga do i-ésimo indivíduo da j-ésima etiologia, respectivamente.
- $\beta_{0 j}$ é o VO2 esperado quando a carga assume seu valor médio e a etiologia assume o valor associado ao índice $j$
- $\beta_{1}$ é a variação esperada de VO2 quando a carga varia em uma unidade 

A Tabela X apresenta os resultados desse modelo.

```{r}
modelo_etiologia <- df %$%
  lm(VO2 ~ etiologia + I(carga - mean(carga)))

tidy(modelo_etiologia, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()
```

A Figura X apresenta o gráfio do VO2 em função da carga, a reta ajustada e o intervalo de confiança para as predições (área em torno da reta).

A Figura X apresenta os gráficos de análise de resíduos: o primeiro gráfico não sugere qualquer anormalidade, como dependência; o segundo indica heterocedasticidade; o terceiro indica que pode ser razoável a normalidade, no entanto, o quarto gráfico demonstra não ser possível tal suposição, visto que o QQ-plot tem concavidade para cima e granda parte da cauda positiva fora da banda de confiança.

```{r}
plot_prediction(modelo_etiologia, df$VO2, "VO2")  
plot_residuals(modelo_etiologia)
```

## Modelo reduzido ao máximo

```{r}
df <- mutate(df, etiologia = forcats::fct_collapse(etiologia, Other = c("C", "CH"), IS = "IS", ID = "ID"))

modelo_reduzido <- df %$%
  lm(VO2 ~ etiologia + I(carga - mean(carga)))

tidy(modelo_reduzido, conf.int = TRUE) %>% 
  select(-statistic) %>% 
  knitr::kable()

plot_prediction(modelo_reduzido, df$VO2, "VO2")  
plot_residuals(modelo_reduzido)
```


# Comparação de modelos

```{r}

```


