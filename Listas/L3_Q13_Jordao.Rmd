--- 
output: 
  pdf_document:
    fig_crop: no
fontsize: 10pt
documentclass: article
geometry: 
 - a4paper
 - textwidth=18cm
 - textheight=21cm
header-includes:
  - \usepackage[brazil, english, portuguese]{babel}
  - \usepackage[utf8]{inputenc}
  - \usepackage[T1]{fontenc}
  - \usepackage[fixlanguage]{babelbib}
  - \usepackage{times}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  fig.align = "center", fig.height = 3, fig.width = 5
  )
options(
  OutDec = ",", 
  digits = 3, 
  # knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```


```{r lib}
library(knitr)
library(readr)
library(magrittr)
library(ggplot2)
library(dplyr)
library(broom)
source("plot_functions.R")
```

```{r 12/13-import, echo=FALSE}
df <- read_table("../Dados/Sef1999REG.prn", col_names = F)
df <- df %>% transmute(Individuo = X1,
                       Grupo = factor(X2),
                       Escova = factor(X3),
                       Dentrificio = factor(X4),
                       Dia = X5,
                       Antes = X6,
                       Depois = X7,
                       Razao = Depois / Antes,
                       Centrada = (Depois - Antes) / Antes)
```

# Questão 7

## Introdução

Com o objetivo de comparar a eficácia entre escovas de dentes comuns e escovas de dentes do tipo monobloco com e sem o uso de dentrifício (pasta de dente) avaliamos a razão entre duas variáveis, o Indíce de Placa Bacteriana (IPB) antes e depois da escovações com as condições citadas anteriormente. Desta forma sendo nossa variável resposta $\frac{IPB_{depois}}{IPB_{antes}}$, quanto menor este valor, melhor desempenho na redução das placas.

Portanto, iremos utilizar da notação:
- $\mathbf Y$: a variável resposta, razão entre os indíces, $\frac{IPB_{depois}}{IPB_{antes}}$;
- $\mathbf x_1$: covariável categorizada, a qual indica o uso de *escova monobloco*; 
- $\mathbf x_2$: covariável categorizada, a qual indica o não uso de *dentrifício*.

## Análise descritiva I

```{r 12-explore, fig.cap="\\label{fig:explo1}Gráfico da relação entre o IPB antes e depois da escovação.", }
df %>% ggplot(aes(x = Antes, y = Depois)) +
  geom_point() +
  facet_grid(Dentrificio ~ Escova) + theme_bw()
```

De forma exploratório observamos na Fig. \ref{fig:explo1} que as 4 retas são muito similares, lembrando que o valor de interesse é coeficiente de inclinação das mesmas.

## Modelagem I

### Modelo 1

Inicialmente ajustamos um modelo levando em conta os dois fatores *tipo da escova* e *uso do dentrifício* e suas interações, sendo ele
$$
\mathbf Y = \beta_0 + \beta1 \mathbf x_1 + \beta_2 \mathbf x_2 + \beta_3 \mathbf x_1 \mathbf x_2 + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$

```{r}
m1 <- lm(Razao ~ Escova * Dentrificio,
         data = df)

m1 %>% tidy(conf.int = T) %>%
  kable(caption = "\\label{tab:m1}")
```

Observamos em Tab. \ref{tab:m1} que os coeficientes dos termos do *dentrifício* e sua interação com o uso *escova monobloco*  estão com p-valores altos, desta forma podemos tentar reduzir o modelo.

Entre tanto, como o termo de interação e uma de suas covariáveis relacionadas são os maiores termos, o termo da interação será removido anteriormente mesmo que o seu p-valor não seja o maior de todos.

### Modelo 2

Sendo assim, o novo modelo a ser ajustado é:
$$
\mathbf Y = \beta_0 + \beta1 \mathbf x_1 + \beta_2 \mathbf x_2 + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$

```{r}
m2 <- lm(Razao ~ Escova + Dentrificio,
         data = df)

m2 %>% tidy(conf.int = T) %>%
  kable(caption = "\\label{tab:m2}")
```

O coeficiente da covariável do uso de *dentrifício* continua não sendo significante e será removido, Tab. \ref{tab:m2}.

### Modelo 3

Desta forma, novo modelo é:
$$
\mathbf Y = \beta_0 + \beta1 \mathbf x_1 + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$

```{r}
m3 <- lm(Razao ~ Escova,
         data = df)
stt <- summary(m3)

m3 %>% tidy(conf.int = T) %>%
  kable(caption = "\\label{tab:m3}")
```

```{r fig.cap="\\label{fig:res1}Gráficos para diagnóstico dos resíduos."}
plot_residuals(m3)
```

Neste modelo reduzido temos evidências que apenas o *tipo da escova* leva à diferenças significantes na razão $\frac{IPB_{depois}}{IPB_{antes}}$, Tab. \ref{tab:m3}. Observando Fig. \ref{fig:res1} podemos ver que por mais que os coeficientes sejam significativos os resíduos não respeitam as suposições do modelo, em destaque, vemos que o gráfico de resíduo "studentizado" não se assemelha a uma distribuição normal e os pontos da cauda não respeitam as bandas do quantil teórico.

Podemos concluir que, apenas temos evidências de que o uso das escovas convencionais leva a uma redução de `r m3$coefficients[1]` $\pm$ `r stt$coefficients[3]` da placa bacteriana e uso da escova monobloco `r m3$coefficients[1] + m3$coefficients[2]` $\pm$ `r stt$coefficients[3] + stt$coefficients[4]`, desta forma, as escovas convencionais se mostram superiores.

## Análise descritiva II

Buscando responder as mesmas perguntas, definimos uma nova variável de interesse, $\frac{IPB_{depois} - IPB_{antes}}{IPB_{antes}}$, onde o melhor resultado para escovação ocorre quando essa medida é mínima, sendo ela zero quando não ouve mudança ao realizar o experimento.

Será utilizado uma nova variável:
  - $\mathbf Y_c$: a variável resposta de interesse, $\frac{IPB_{depois} - IPB_{antes}}{IPB_{antes}}$;

```{r fig.cap="\\label{fig:explo2}Gráfio da relação entre o denominador e o numerador da nova variável resposta"}
df %>% ggplot(aes(x = Antes, y = Depois - Antes)) +
  geom_point() +
  facet_grid(Dentrificio ~ Escova) + theme_bw()
```

Na Fig. \ref{fig:explo2} a mudança na interpretação dos coeficientes ficam claras, pois a inclicação das amostras é alterada.

## Modelagem II

### Modelo 4

Iniciamos a modelagem com o modelo completo, levando em contas as mesmas cováriaveis que no modelo 1 e a interação entre elas.

$$
\mathbf Y_c = \beta_0 + \beta1 \mathbf x_1 + \beta_2 \mathbf x_2 + \beta_3 \mathbf x_1 \mathbf x_2 + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$

```{r}
m4 <- lm(Centrada ~ Escova * Dentrificio,
         data = df)
m4 %>% tidy(conf.int = T) %>%
  kable(caption = "\\label{tab:m4}")
```

Podemos notar que os valores ajustados dos coeficientes são os mesmos, exceto no intercepto, esse é um comportamento esperado, uma vez que houve apenas uma mudança na localização da variável resposta.

Como no caso anterior observamos que a presença de *dentrifício* não é significativa, tanto sozinho, quanto em conjunto com o outro fator, *tipo da escova*, desta forma, reduzimos o modelo removendo a interação.

### Modelo 5

Este é o novo modelo a ser ajustado.

$$
\mathbf Y_c = \beta_0 + \beta1 \mathbf x_1 + \beta_2 \mathbf x_2 + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$

```{r}
m5 <- lm(Centrada ~ Escova + Dentrificio,
         data = df)
m5 %>% tidy(conf.int = T) %>%
  kable(caption = "\\label{tab:m5}")
```

O novo ajuste não apresenta melhora na significância no fator do *dentrifício*.

### Modelo 6

Um novo modelo é ajustado, semelhante ao modelo 3.

$$
\mathbf Y_c = \beta_0 + \beta1 \mathbf x_1 + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$
```{r}
m6 <- lm(Centrada ~ Escova,
         data = df)
stt <- summary(m6)

m6 %>% tidy(conf.int = T) %>%
  kable(caption = "\\label{tab:m6}")
```

Podemos observar que os coeficientes restantes são significativos, e os resíduos, Fig \ref{fig:res2} são equivalentes ao apresenteados pelo modelo 3, não respeitando as suposições feitas pelo modelo.

```{r fig.cap="\\label{fig:res2}Gráficos para diagnóstico dos resíduos."}
plot_residuals(m6)
```

Desta forma, concluímos que que o uso das escovas convencionais reduzem `r m6$coefficients[1]` $\pm$ `r stt$coefficients[3]` em média o IPB encontrado antes da escovação e uso da escova monobloco `r m6$coefficients[1] + m6$coefficients[2]` $\pm$ `r stt$coefficients[3] + stt$coefficients[4]`, desta forma, as escovas convencionais se mostram superiores.

Podemos concluir que o deslocamento na posição da variável de interesse não resulto em diferenças nas conclusões das análises

Para um estudo mais aprofundado para relação da razão do $IPB_{depois}$ sobre o $IPB_{antes}$ um modelo multiplicativo poderia ser mais adequado modelando o $IPB_{depois}$ em função dos fatores e do $IPB_antes$.
