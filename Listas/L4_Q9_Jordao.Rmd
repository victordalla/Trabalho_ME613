--- 
output: 
  pdf_document:
    fig_crop: no
fontsize: 10pt
documentclass: article
geometry: 
 - a4paper
 - textwidth=18cm
 - textheight=21cm
header-includes:
  - \usepackage[brazil, english, portuguese]{babel}
  - \usepackage[utf8]{inputenc}
  - \usepackage[T1]{fontenc}
  - \usepackage[fixlanguage]{babelbib}
  - \usepackage{times}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  fig.align = "center", fig.height = 3, fig.width = 5
  )
options(
  OutDec = ",", 
  digits = 3, 
  # knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```

```{r libs}
library(minpack.lm)
library(magrittr)
library(ggplot2)
library(knitr)
library(broom)
source("plot_functions.R")
```

```{r}
df <- read.table("../Dados/Ratkowsky.dat")
colnames(df) <- c("idade", "peso")
```

```{r}
plot_nls_residuals <- function(model, binwidth = NULL, bins = NULL) {
  # precisa de ggplot2, gridExtra, qqplotr
  residuals <- data.frame(
    residual = resid(model), 
    fitted = fitted(model), 
    index = 1:length(fitted(model))
  )
  
  p <- ggplot2::ggplot(residuals) + 
    ggplot2::labs(y = "resíduo") + ggplot2::theme_classic()
  
  gridExtra::grid.arrange(
    nrow = 2, 
    p + ggplot2::geom_point(aes(x = index, y = residual), col = "gray30", alpha = 0.80) + 
      ggplot2::labs(x = "índice"), 
    p + ggplot2::geom_point(aes(x = fitted, y = residual), col = "gray30", alpha = 0.80) + 
      ggplot2::labs(x = "predito"), 
    p + ggplot2::geom_histogram(
      aes(x = residual), fill = "gray30", col = "gray80",
      binwidth = binwidth, bins = bins
      ) + ggplot2::labs(x = "resíduo", y = ""), 
    ggplot2::ggplot(residuals, aes(sample = residual)) + 
      qqplotr::stat_qq_band(bandType = "pointwise") + 
      qqplotr::stat_qq_line() + 
      qqplotr::stat_qq_point(col = "gray20", alpha = 0.80) + 
      ggplot2::labs(x = "quantil teórico", y = "quantil amostral") + ggplot2::theme_classic()
  )
}
```

# Questão 9

## Introdução

Os correspondem a uma amostra de 71 coelhos da espécia *Oryctolagus Cuniculuse*, onde foram registradas suas idade (em dias) e o peso (em mg) de sua lente ocular seca.

Sendo do nosso interesse nesta análise, explicar o peso da lente em função da idade dos indivíduos.

A notação utilizada será:
  - $\mathbf Y$: a variável resposta, peso;
  - $\mathbf x$: covariável, idade. 

## Análise Descritiva

Inicialmente avaliando a Fig. \ref{fig:explo} podemos ver que a relação entre as váriaveis não é linear e que a dispersão dos dados aumenta conforme os coelhos envelhecem, o que é esperado, uma vez que cada indivíduo se desenvolve de forma diferente, com o passar do tempo as diferenças no volume e massa dos seus orgãos vão aumentendo.

```{r fig.cap="\\label{fig:explo}Peso da lente ocular dos coelhos em função da sua idade em dias."}
df %>% ggplot(aes(idade, peso)) + geom_point() +
  theme_bw()
```

# Modelo Linear (no Parâmetros) 1

Devido a estrutura não linear podemos iniciar nossa modelagem utilizando a regressão linear com polinômio de segundo grau, verificando se os dados seguem uma parábola.

$$
\mathbf Y = \beta_0 + \beta1 \mathbf x_1 + \beta_2 \mathbf x_1 ^ 2 + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$

```{r}
m1 <- lm(peso ~ poly(idade, 2, raw = T), data = df)

m1 %>% tidy(conf.int = T) %>%
  kable(caption = "\\label{tab:m1}")
```

```{r fig.cap="\\label{fig:m1}Curva do modelo 1 ajustado."}
df %>% ggplot(aes(idade, peso)) +
  geom_point() + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 2, raw = T), se = T) +
  theme_bw()
```

```{r fig.cap="\\label{fig:resm1}Gráficos para diagnóstico dos resíduos do modelo 1"}
plot_residuals(m1)
```


Comentar sobre o p-valor significativo, citar as Figuras (Fig. \ref{fig:m1}, Fig. \ref{fig:resm1}) no texto, etc.
Comentar que um dos pontos do modelo quadrático não ser adequado é devido a estrutura da parábola, que espera que os valores decrescam, o que não acontece com o peso das corneas em função da idade.

# Modelo Não Linear 1

Podemos buscar alguma função que se aproxime da estrutura dos dados, para isso tentarei ajustar o modelo:

$$
\mathbf Y = \beta_0 \log (\beta_1 + \beta_2 \mathbf x) + \epsilon \quad \text{onde} \quad \epsilon \sim N(0, I\sigma^2)
$$

Variaveis positivas, faz sentido usar o log, etc...

```{r}
m2 <- nlsLM(peso ~ beta0 * log(beta1 + beta2 * idade), start = c(beta0=1, beta1=1, beta2=1), data = df)
```

```{r}
summary(m2)
```
```{r fig.cap="\\label{fig:m2}Gráficos da curva do modelo 3"}
df %>% ggplot(aes(idade, peso)) +
  geom_point() +
  geom_line(aes(idade, fitted(m2), col = "red")) +
  theme_bw()
```


```{r fig.cap="\\label{fig:resm2}Gráficos para diagnóstico dos resíduos do modelo 3"}
plot_nls_residuals(m2)
```


Note que o residuo não é mais *studentizado*
