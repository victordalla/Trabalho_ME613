--- 
output: 
  pdf_document:
    fig_crop: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
  )
options(
  OutDec = ",", 
  digits = 4, 
  knitr.table.format = "latex", 
  xtable.comment = FALSE
  )
```

```{r lib}
library(dplyr)
library(ggplot2)
library(forcats)
library(magrittr)
library(broom)
library(xtable)
library(knitr)
source("plot_functions.R")
source("comparacao_de_modelo.R")
```

```{r dados, echo=FALSE}
dados <- read.table("salary.txt", header = FALSE, col.names = c("salario_anual", "sexo", "posicao_empresa", "experiencia"))

#dados$posicao_empresa <- as.factor(dados$posicao_empresa)
```

## Introdução

O conjunto de dados em questão traz informações a respeito de uma amostra aleatória de 220 executivos e apresenta para cada executivo, o salário anual (em mil USD), o sexo (Feminino ou Masculino), experiência (em anos) e a posição na empresa (escore que varia de 1 a 9 e, quanto maior o valor, mais alta a posição). Os dados estão disponíveis no site "https://www.ime.usp.br/~giapaula/salary.dat".

O objetivo é estudar o relacionamento do sálario anual em função dos anos de experiência e a posição na empresa para os dois grupos formados pela variável sexo (Feminino e Masculino). Utilizamos a metodologia dos modelos normais lineares homocedásticos, veja
Draper and Smith (1998), metodologias de verificação da qualidade do ajuste e comparação de modelos apropriados, veja Paula (2013) com o suporte computacional do R, veja Faraway (2014).

## Análise descritiva

Para entender a relação do salário dos executivos em função dos anos de experiência e ao cargo na empresa separado por sexo, apresentamos na Figura \ref{fig:pos_sal} o gráfico de dispersão entre o salário e a posição na empresa entre homens e mulheres, o gráfico de boxplot do salário para cada sexo presente na Figura \ref{fig:sex_Sal}, e por fim o gráfico de disperção do salário e a experiência separado por sexo com destaque para os diferentes níveis de cargo na empresa na Figura \ref{fig:completo}.

Conforme revelam os gráficos das Figuras \ref{fig:pos_sal} e \ref{fig:completo},  podemos perceber que a relação entre o salário e o cargo na empresa e os anos de experiência podem ser representados por uma reta ou uma parábola, já que notamos indícios de aumento do salário com o aumento da posição e com o aumento da experiência para ambos os sexos.

Entretanto, por meio do gráfico presente na Figura \ref{fig:completo} pode-se notar que na presença de experiência e posição, as mulheres ganham em média mais do que os homens. Quando as varáveis não são levadas em conta ocorre o contrário, ou seja, a média do salário dos homens é maior do que o salário das mulheres como apresenta o boxplot da Figura \ref{fig:sex_sal}.


```{r pos_sal, fig.width=6, fig.height=3, fig.cap="Disperção", fig.pos="center"}
dados %>%
  ggplot(aes(factor(posicao_empresa), salario_anual)) +
  geom_point() +
  facet_wrap(~sexo) +
  theme_bw()
#grid.arrange(plot1, plot2, nrow=1, ncol=2)
```

```{r sex_sal, fig.width= 4, fig.height=3, fig.pos="center", fig.cap="salario_sexo"}
dados %>% 
  ggplot(aes(sexo, salario_anual)) +
  geom_boxplot()+
  theme_classic()
```

```{r plot_completo, fig.cap="completo", }
dados %>%
  ggplot(aes(experiencia, salario_anual, fill = factor(posicao_empresa), color = factor(posicao_empresa))) + 
  geom_point()+
  facet_grid(~sexo)+
  labs(y = "Salário Anual",
       x = "Anos de experiência",
       color = "Cargo", fill="Cargo")+
  theme_minimal()
```

## Análise inferencial

<!--
- especificar o modelo
- análise(s) de resíduo(s)
- hipóteses de interesse (O NÍVEL DE SIGNIFICÂNCIA DEVE SER ESPECIFICADO NO RELATÓRIO)
-análise de multicolinearidade
- modelagem a heterocedasticidade
- gráficos e comentários
- deverão   ser   usadas   as metodologias constantes na questão
- caso o modelo usado não se adeque bem   aos   dados,   comentários   a   respeito   deverão   ser   feitos,   mencionando   que   outras metodologias devem ser utilizadas (não, necessariamente, precisa ser dito quais) -->

Sejam $Y_{i}$ o valor do salário anual do empresário $i$ onde $i = 1, ..., 220$. Inicialmente o modelo que utilizaremos para explicar a variação do salário em função dos anos de experiência e a posição na empresa considerando o sexo é o Modelo 1 definido como 
$$Y_{i} = \beta_{0} + \beta_{1}x_i+\beta_2 (x_{2 i} - \bar{x}_2) + \beta_{3 } (x_{3 i} - \bar{x}_3)  + \epsilon_{i }, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$$, onde

- $x_{1i}$ assume o valor 0 se o indivíduo $i$ for do sexo Feminino e 1 se o indivíduo $i$ for Masculino (sexo Masculino é a casela de referência)
- $x_{2 i}$ é o valor da variável anos de experiência do indivíduo $i$;
- $x{ 3i}$ é o valor da variável posição na empresa do i-ésimo indivíduo
- $\beta_{0}$ é o salário esperado quando a posição na empresa e os anos de experiência assumem seu valor médio simultaneamente para o sexo Feminino
- De forma análoga, $\beta_{0} + \beta_1$ é o valor esperado do salário dos homens quando $x_2$ e $x_3$ assumem simultaneamente seu valor médio;
- $\beta_{2}$ é a variação esperada do salário quando o ano de experiência varia em uma unidade e as outras variáveis se mantém constantes;
- $\beta{3}$ é a variação esperada do salário quando a posição na empresa varia em uma unidade e as outras variáveis se mantém constantes.

#Resultados
<!--Uma hipótese de interesse é testar se o efeito dos anos de experiênia é igual para amobos sexos: $H_0: \beta_{1 0} = \beta_{1 1} = 0$ \textit{versus} $H_1: \text{para algum algum} \ j \ \text{tal que} \ \beta_{1 j} \neq 0$, ou seja, se é possível reduzir o modelo desconsiderando a interação entre o sexo e os anos de experiência. De forma similar, podemos testar se o efeito da posição na empresa é igual para homens e mulheres, ou seja, $H_0: \beta_{2 0} = \beta_{2 1} = 0$ \textit{versus} $H_1: \text{para algum algum} \ j \ \text{tal que} \ \beta_{2 j} \neq 0$-->

```{r, res1, fig.cap="Resíduos do Modelo 1"}
modelo1 <- dados %$%
  lm(salario_anual ~ sexo + I(experiencia - mean(experiencia)) + I(posicao_empresa - mean(posicao_empresa)))

plot_residuals(modelo1)
```

```{r, pred1, fig.cap="Predição - Modelo 1"}
plot_prediction(modelo1, response = dados$salario_anual, response_name = "salario_anual")
```

```{r, summary1, fig.cap="Tabela com as estimativas"}
tidy(modelo1, conf.int = TRUE) %>% 
  select(-statistic) %>%
  kable()
```

A Figura \ref{fig: res1} apresenta os gráficos que iremos utilizar para análise de diagnóstico do modelo por meio dos resíduos. 

```{r}
modelo5 <- dados %$%
  lm(salario_anual ~ sexo + I(experiencia - mean(experiencia))*I(posicao_empresa - mean(posicao_empresa)))

plot_residuals(modelo5)
plot_prediction(modelo5, response = dados$salario_anual, response_name = "salario_anual")
tidy(modelo5, conf.int = TRUE) %>% 
  select(-statistic) %>%
  kable()
kable(calc.estat.mod.comp.MRNLH(modelo5))
```


```{r}
modelo4 <- dados %$%
  lm(salario_anual ~ sexo*I(experiencia - mean(experiencia)) + I(posicao_empresa - mean(posicao_empresa)))

plot_residuals(modelo4)
plot_prediction(modelo4, response = dados$salario_anual, response_name = "salario_anual")
tidy(modelo4, conf.int = TRUE) %>% 
  select(-statistic) %>%
  kable()
kable(calc.estat.mod.comp.MRNLH(modelo4))
```

```{r}
ggplot(dados, aes(x = experiencia, y = salario_anual)) +
  geom_point() +
  facet_grid(~sexo) + 
  geom_smooth(method = "lm")

ggplot(dados, aes(x = posicao_empresa, y = salario_anual)) +
  geom_point() +
  facet_grid(~sexo) + 
  geom_smooth(method = "lm")
```


```{r}
modelo2 <- dados %$%
  lm(salario_anual ~ sexo + I(experiencia - mean(experiencia)) + I(posicao_empresa - mean(posicao_empresa)))
plot_residuals(modelo2)
plot_prediction(modelo2, response = dados$salario_anual, response_name = "salario_anual")
tidy(modelo2, conf.int = TRUE) %>% 
  select(-statistic) %>%
  kable()
kable(calc.estat.mod.comp.MRNLH(modelo2))
```

<!--Uma hipótese de interesse é testar se os efeitos de VO2 são iguais para todas as etiologias: $H_0: \beta_{1 1} = ... = \beta_{1 4} = 0$ \textit{versus} $H_1: \text{para algum algum} \ j \ \text{tal que} \ \beta_{1 j} \neq 0$, ou seja, se é possível reduzir o modelo desconsiderando a interação entre carga e etiologia.

Nesse caso, o modelo que explica a variação do consumo de oxigênio (VO2) da carga de compensação respiratório (carga) considerando as etiologias de maneita aditiva (sem interações) é o Modelo 2: $Y_{i j} = \beta_{0 j} + \beta_{1} (x_{i j} - \bar{x}) + \epsilon_{i j}, \epsilon_{i j} \stackrel{iid}\sim N(0, \sigma^2)$, onde

- $Y_{i j}$ e $x_{i j}$ é o VO2 e a carga do i-ésimo indivíduo da j-ésima etiologia, respectivamente.
- $\beta_{0 j}$ é o VO2 esperado quando a carga assume seu valor médio e a etiologia assume o valor associado ao índice $j$
- $\beta_{1}$ é a variação esperada de VO2 quando a carga varia em uma unidade -->

